#!/bin/bash

SESSION_NAME="tdl"

# set offset based on number of arguments
offset="+0day"
if [ $# -ge 1 ]; then
	offset="$1day"
fi

# path to directory of lists
if ! [ -d "$tdir" ]; then
	tdir="$HOME/Documents/todo-lists"
fi

# make directories recursively
tpath="$tdir/lists/$(date --date $offset +%Y)/$(date --date $offset +%m)"
mkdir -p $tpath

# if not in a tmux pane, either attaches or creates session with name tdl
if [ -z ${TMUX+x} ]; then
	# check whether SESSION_NAME tmux exists
	tmux has-session -t "${SESSION_NAME}" 2>/dev/null
	if [ $? -ne 0 ] ; then
		tmux new-session -s "${SESSION_NAME}" -n "latex" -c "${tdir}" -d
		
		tmux send-keys -t "${SESSION_NAME}:latex" "cd latex" C-m
		tmux send-keys -t "${SESSION_NAME}:latex" "open ." C-m
		tmux send-keys -t "${SESSION_NAME}:latex" "entr-latex todo" C-m
		tmux split-window -t "${SESSION_NAME}:latex" -v -c "${tdir}/latex" -l "90%"
		
		tmux new-window -t "${SESSION_NAME}" -n "packlist" -c "${tdir}/packlist"
		tmux send-keys -t "${SESSION_NAME}:packlist" "open ." C-m
		tmux send-keys -t "${SESSION_NAME}:packlist" "entr-latex packlist" C-m
		tmux split-window -t "${SESSION_NAME}:packlist" -v -c "${tdir}/packlist" -l "90%"

		tmux new-window -t "${SESSION_NAME}" -n "lists" -c "${tdir}/lists"
		tmux send-keys -t "${SESSION_NAME}:lists" "tdl" C-m
	fi

	tmux a -t "${SESSION_NAME}"
else 
	# getting path + name of list
	filename="${tpath}/$(date --date $offset +%F).md"
	# update git repo
	cd "${tpath}" && git pull
	
	# checking if file exists
	if ! [ -f "${filename}" ]; then
		touch ${filename}
		echo "# To Do List $(date --date $offset +'%A %F')" > "${filename}"
		cat "${tdir}/header.md" >> "${filename}"
	fi

	vim "${filename}"
	
	# janky git adding tdl file, all non-list files
	git add "${tdir}"
	git restore --staged "${tdir}/lists"
	git add "${filename}"
	git commit -m "updated $(date --date $offset +%F).md"
	git push
fi
